<!-- Lesson 3 HTML - Buffers, Reducers, and Exporting -->
<h2>Lesson 3 â€” Buffers, Reduction Functions, and Exporting CSV Files</h2>

<p>In this lesson, youâ€™ll work with bird survey data in Google Earth Engine. Youâ€™ll create buffers around survey points, extract landcover information for each buffer, and export your results as a .csv file.</p>

<p>In this lesson, youâ€™ll learn how to:</p>
<ul>
  <li>Upload and map point data</li>
  <li>Create buffers around points using <code>.map()</code> and <code>.buffer()</code></li>
  <li>Use a <code>Reducer</code> to count landcover pixels</li>
  <li>Rework data into a flat table</li>
  <li>Export your table to Google Drive</li>
</ul>

<h3>3.1 Upload and map the Blue-gray Gnatcatcher data</h3>

<p>We'll start by uploading a .csv file containing Blue-gray Gnatcatcher detections. This file includes latitude and longitude information, so when you upload it to Earth Engine, it will automatically be treated as a <strong>FeatureCollection</strong> (vector data).</p>

<p>After uploading, create a variable called <code>bggn</code> and set it equal to your feature collection.</p>

<!-- CODE Row -->
<div style="display:flex; justify-content:space-between; align-items:center;">
  <div id="code31" style="visibility:hidden; height:auto; background-color:#f0f0f0; border-left:4px solid #ccc; padding:2px 6px; margin:0px; flex:1;">
<code>var bggn = ee.FeatureCollection("projects/ee-anastasiarahlin/assets/gnatcatcher_data");
print("bggn featureCollection:", bggn);</code>
  </div>
  <button id="codeButton31" onclick="
    var el = document.getElementById('code31');
    var btn = document.getElementById('codeButton31');
    var showing = el.style.visibility === 'visible';
    el.style.visibility = showing ? 'hidden' : 'visible';
    btn.style.backgroundColor = showing ? '#1e88e5' : '#1565c0';
  " style="background-color:#1e88e5; color:white; border:none; padding:4px 10px; border-radius:6px; font-weight:bold; cursor:pointer; margin:4px 0px 0px 8px; width:60px;">
    code
  </button>
</div>

<p>Now map your <code>bggn</code> points and center the map on them.</p>

<!-- CODE Row -->
<div style="display:flex; justify-content:space-between; align-items:center;">
  <div id="codeButton32" style="visibility:hidden; height:auto; background-color:#f0f0f0; border-left:4px solid #ccc; padding:2px 6px; margin:0px; flex:1;">
<code>Map.addLayer(bggn, {}, 'BGGN points');
Map.centerObject(bggn);</code>
  </div>
  <button id="codeButton32" onclick="
    var el = document.getElementById('codeButton32');
    var btn = document.getElementById('codeButton32');
    var showing = el.style.visibility === 'visible';
    el.style.visibility = showing ? 'hidden' : 'visible';
    btn.style.backgroundColor = showing ? '#1e88e5' : '#1565c0';
  " style="background-color:#1e88e5; color:white; border:none; padding:4px 10px; border-radius:6px; margin:4px 0px 0px 8px; font-weight:bold; width:60px;">
    code
  </button>
</div>

<h3>3.2 Import the NLCD landcover dataset</h3>

<p>Now weâ€™ll bring in the National Landcover Database (NLCD) for 2021. We'll use it to see what types of habitat the gnatcatchers were using.</p>

<!-- CODE Row -->
<div style="display:flex; justify-content:space-between; align-items:center;">
  <div id="codeButton33" style="visibility:hidden; height:auto; background-color:#f0f0f0; border-left:4px solid #ccc; padding:2px 6px; margin:0px; flex:1;">
<code>var nlcd = ee.ImageCollection("USGS/NLCD_RELEASES/2021_REL/NLCD");
print(nlcd);</code>
  </div>
  <button id="codeButton33" onclick="
    var el = document.getElementById('codeButton33');
    var btn = document.getElementById('codeButton33');
    var showing = el.style.visibility === 'visible';
    el.style.visibility = showing ? 'hidden' : 'visible';
    btn.style.backgroundColor = showing ? '#1e88e5' : '#1565c0';
  " style="background-color:#1e88e5; color:white; border:none; padding:4px 10px; border-radius:6px; font-weight:bold; margin:4px 0px 0px 8px; width:60px;">
    code
  </button>
</div>

<p>Check how many bands there are and what the first band ("landcover") represents. Select the landcover band using either its name or its index.</p>

<!-- CODE Row -->
<div style="display:flex; justify-content:space-between; align-items:center;">
  <div id="codeButton34" style="visibility:hidden; height:auto; background-color:#f0f0f0; border-left:4px solid #ccc; padding:2px 6px; margin:0px; flex:1;">
<code>var landcover = nlcd.select('landcover');
print("landcover", landcover);
print('Number of images in landcover:', landcover.size());</code>
  </div>
  <button id="codeButton34" onclick="
    var el = document.getElementById('codeButton34');
    var btn = document.getElementById('codeButton34');
    var showing = el.style.visibility === 'visible';
    el.style.visibility = showing ? 'hidden' : 'visible';
    btn.style.backgroundColor = showing ? '#1e88e5' : '#1565c0';
  " style="background-color:#1e88e5; color:white; border:none; padding:4px 10px; border-radius:6px; font-weight:bold; margin:4px 0px 0px 8px; width:60px;">
    code
  </button>
</div>

<h3>3.3 Create 2000m buffers around each bird point</h3>

<p>We want to know what landcover is around each gnatcatcher location. To do that, we'll create 2000 meter buffers around each point. Think of the <code>.map()</code> function like: "go one by one, do the same thing to each point." We'll use <code>.buffer(2000)</code> inside.</p>

<!-- CODE Row -->
<div style="display:flex; justify-content:space-between; align-items:center;">
  <div id="codeButton35" style="visibility:hidden; height:auto; background-color:#f0f0f0; border-left:4px solid #ccc; padding:2px 6px; margin:0px; flex:1;">
<code>var buffers2000m = bggn.map(function(point_count_location) {
  return point_count_location.buffer(2000);
});
print("my_buffers200m:", buffers2000m);
Map.addLayer(buffers2000m, {color: 'green'}, 'BGGN buffers');
Map.centerObject(buffers2000m);</code>
  </div>
  <button id="codeButton35" onclick="
    var el = document.getElementById('codeButton35');
    var btn = document.getElementById('codeButton35');
    var showing = el.style.visibility === 'visible';
    el.style.visibility = showing ? 'hidden' : 'visible';
    btn.style.backgroundColor = showing ? '#1e88e5' : '#1565c0';
  " style="background-color:#1e88e5; color:white; border:none; padding:4px 10px; border-radius:6px; font-weight:bold; margin:4px 0px 0px 8px; width:60px;">
    code
  </button>
</div>

<h3>3.4 Use a reducer to count landcover types</h3>

<p>Reducers help us summarize many values into fewer values. We'll use <code>ee.Reducer.frequencyHistogram()</code> to count the number of pixels of each landcover type inside each buffer.</p>

<!-- CODE Row -->
<div style="display:flex; justify-content:space-between; align-items:center;">
  <div id="codeButton36" style="visibility:hidden; height:auto; background-color:#f0f0f0; border-left:4px solid #ccc; padding:2px 6px; margin:0px; flex:1;">
<code>var landcover2021 = landcover.first();
var landcover_pixel_counts = landcover2021.reduceRegions({
  collection: buffers2000m,
  reducer: ee.Reducer.frequencyHistogram(),
  scale: 30
});
print('Landcover pixel counts per buffer:', landcover_pixel_counts);</code>
  </div>
  <button id="codeButton36" onclick="
    var el = document.getElementById('codeButton36');
    var btn = document.getElementById('codeButton36');
    var showing = el.style.visibility === 'visible';
    el.style.visibility = showing ? 'hidden' : 'visible';
    btn.style.backgroundColor = showing ? '#1e88e5' : '#1565c0';
  " style="background-color:#1e88e5; color:white; border:none; padding:4px 10px; border-radius:6px; font-weight:bold; margin:4px 0px 0px 8px; width:60px;">
    code
  </button>
</div>

<h3>3.5 Flatten the data into a table</h3>

<p>Each buffer now has a histogram dictionary. We want to flatten this into one table with each landcover type as a column. We'll map over each feature and pull out its histogram.</p>

<!-- CODE Row -->
<div style="display:flex; justify-content:space-between; align-items:center;">
  <div id="codeButton37" style="visibility:hidden; height:auto; background-color:#f0f0f0; border-left:4px solid #ccc; padding:2px 6px; margin:0px; flex:1;">
<code>var histograms = landcover_pixel_counts;
var flattened = ee.FeatureCollection(
  histograms.map(function(feature) {
    var hist = ee.Dictionary(feature.get('histogram'));
    var newFeature = ee.Feature(null, hist)
      .set('stationID', feature.get('stationID'));
    return newFeature;
  })
);
print('Flattened FeatureCollection:', flattened);</code>
  </div>
  <button id="codeButton37" onclick="
    var el = document.getElementById('codeButton37');
    var btn = document.getElementById('codeButton37');
    var showing = el.style.visibility === 'visible';
    el.style.visibility = showing ? 'hidden' : 'visible';
    btn.style.backgroundColor = showing ? '#1e88e5' : '#1565c0';
  " style="background-color:#1e88e5; color:white; border:none; padding:4px 10px; border-radius:6px; font-weight:bold; margin:4px 0px 0px 8px; width:60px;">
    code
  </button>
</div>

<h3>3.6 Export the table to a CSV</h3>

<p>Finally, export the table to your Google Drive so you can work with it in Excel, R, or another program.</p>

<!-- CODE Row -->
<div style="display:flex; justify-content:space-between; align-items:center;">
  <div id="codeButton38" style="visibility:hidden; height:auto; background-color:#f0f0f0; border-left:4px solid #ccc; padding:2px 6px; margin:0px; flex:1;">
<code>Export.table.toDrive({
  collection: flattened,
  description: 'BGGN_landcover_pixel_counts',
  fileFormat: 'CSV'
});</code>
  </div>
  <button id="codeButton38" onclick="
    var el = document.getElementById('codeButton38');
    var btn = document.getElementById('codeButton38');
    var showing = el.style.visibility === 'visible';
    el.style.visibility = showing ? 'hidden' : 'visible';
    btn.style.backgroundColor = showing ? '#1e88e5' : '#1565c0';
  " style="background-color:#1e88e5; color:white; border:none; padding:4px 10px; border-radius:6px; font-weight:bold; margin:4px 0px 0px 8px; width:60px;">
    code
  </button>
</div>

<p>Nice work! You just mapped point data, created buffers, used a reducer, reorganized data, and exported a table!ðŸŒž</p>

